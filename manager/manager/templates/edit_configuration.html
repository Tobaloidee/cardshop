{% extends "base.html" %}
{% load static %}
{% load manager %}

{% block content %}

	<ul class="nav nav-tabs" id="configMenuTabHolder" role="tablist">
		<li class="nav-item"><a class="nav-link active" id="general-tab" data-toggle="tab" href="#general" role="tab" aria-controls="general" aria-selected="true">General</a></li>
		<li class="nav-item"><a class="nav-link" id="branding-tab" data-toggle="tab" href="#branding" role="tab" aria-controls="branding" aria-selected="false">Branding</a></li>
		<li class="nav-item"><a class="nav-link" id="tools-tab" data-toggle="tab" href="#tools" role="tab" aria-controls="tools" aria-selected="false">Tools</a></li>
		<li class="nav-item"><a class="nav-link" id="contents-tab" data-toggle="tab" href="#contents" role="tab" aria-controls="contents" aria-selected="false">Contents</a></li>
		<li class="nav-item"><a class="nav-link disabled">
			<span id="img_size_holder" class="info" data-container="body" data-toggle="popover" data-trigger="hover" data-content="Size of Selected Contents"><i class="fas fa-hdd"></i> <span id="image_req_size">?</span></span> â€“ 
			<span id="sd_size_holder" class="warning" data-container="body" data-toggle="popover" data-trigger="hover" data-content="Minimum SD-card Size required for Selected Contents"><i class="fa fa-save"></i> <span id="sd_size">?</span></span>
		</a></li>
	</ul>

	<p></p>

	<form>
	<div class="tab-content" id="configMenuTabHolderContent">
	<div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
		<h3>Plug</h3>
		<div class="form-row visual-group">
			<div class="form-group col-md-6">
			  <label for="plugName">Name</label>
			  <input type="text" class="form-control" id="plugName" placeholder="My Box" value="{{ config.project_name }}" aria-describedby="plugNameHelp" />
			  <small id="plugNameHelp" class="form-text text-muted">Used to name your Box and its WiFi</small>
			</div>
			<div class="form-group col-md-6">
			  <label for="plugSize">Configuration Name</label>
			  <input type="text" class="form-control" id="plugName" placeholder="My Project Config" value="{{ config.name }}" aria-describedby="configurationNameHelp" />
			  <small id="configurationNameHelp" class="form-text text-muted">Used <strong>only within the Cardshop</strong>.</small>
			</div>
		</div>

		<h3>Region</h3>
		<div class="form-row visual-group">
			<div class="form-group col-md-6">
			  <label for="plugLanguage">Language</label>
			  <select class="form-control" id="plugLanguage">
			  	{% for key, value in languages.items %}
			  	<option value="{{ key }}"{% if config.language == key %} selected="selected"{% endif %}>{{ value }}</option>
			  	{% endfor %}
			  </select>
			</div>
			<div class="form-group col-md-6">
			  <label for="plugTimezone">Timezone</label>
			  <select class="form-control" id="plugTimezone">
			  	<option value="UTC">UTC</option>
			  	<option value="Europe/Paris">Europe/Paris</option>
			  	{% for timezone in timezones %}
			  	<option value="{{ timezone }}"{% if config.timezone == timezone %} selected="selected"{% endif %}>{{ timezone }}</option>
			  	{% endfor %}
			  </select>
			</div>
		</div>

		<h3>Security</h3>
		<div class="form-row visual-group">
			<div class="form-group col-md-4">
			  <label for="plugWiFiPassword">WiFi Password</label>
			  <input type="text" class="form-control" id="plugWiFiPassword" placeholder="Open" aria-describedby="plugWiFiPasswordHelp"  {% if config.wifi.protected %}value="{{ config.wifi.password }}"{% endif %} />
			  <small id="plugWiFiPasswordHelp" class="form-text text-muted">Leave empty for Open WiFi</small>
			</div>
			<div class="form-group col-md-4">
			  <label for="plugUsername">Admin Account</label>
			  <input type="text" class="form-control" id="plugUsername" value="{{ config.admin_account.login }}" />
			</div>
			<div class="form-group col-md-4">
			  <label for="plugPassword">Admin Password</label>
			  <input type="text" class="form-control" id="plugPassword" value="{{ config.admin_account.password }}" aria-describedby="plugWiFiPasswordHelp" />
			  <small id="plugWiFiPasswordHelp" class="form-text text-muted">To manage Ideascube, KA-Lite, Aflatoun, EduPi</small>
			</div>
		</div>
	</div>

	<div class="tab-pane fade" id="branding" role="tabpanel" aria-labelledby="branding-tab">
		
		<h3>Branding</h3>
		<div class="form-row visual-group">
			<div class="form-group col-md-4">
			  <label for="plugLogo">Logo</label>
			  <input type="file" class="form-control" id="plugLogo">
			</div>
			<div class="form-group col-md-4">
			  <label for="plugFavicon">Favicon</label>
			  <input type="file" class="form-control" id="plugFavicon">
			</div>
			<div class="form-group col-md-4">
			  <label for="plugStyle">CSS</label>
			  <input type="file" class="form-control" id="plugStyle">
			</div>
		</div>

	</div>

  	<div class="tab-pane fade" id="tools" role="tabpanel" aria-labelledby="tools-tab">
  		<h3>Tools</h3>
		<div class="form-row visual-group">
			<div class="form-group col-md-4">
			  <label for="plugContentEdupi">EduPi <span>(1MiB)</span></label>
			  <input type="checkbox" name="plugContentEdupi" id="config_edupi" {% if config.content.edupi %} checked{% endif %} data-toggle="toggle" aria-describedby="plugContentEdupiHelp" class="changes-size">
			  <small id="plugContentEdupiHelp" class="form-text text-muted">Share arbitrary files with all users</small>
			</div>
			<div class="form-group col-md-4">
			  <label for="plugContentEdupiResources">EduPi Resources</label>
			  <input type="text" name="plugContentEdupiResources" id="config_edupi_resources" aria-describedby="plugContentEdupiResourcesHelp" class="changes-size form-control" placeholder="URL to a ZIP file" value="{{ config.content.edupi_resources|default_if_none:"" }}" />
			  <small id="plugContentEdupiResourcesHelp" class="form-text text-muted">ZIP folder archive of documents to initialize EduPi with</small>
			</div>
			<div class="form-group col-md-4">
			  <label for="plugContentAflatoun">Aflatoun <span>(3.93GiB)</span></label>
			  <input type="checkbox" name="plugContentAflatoun" id="config_aflatoun" {% if config.content.aflatoun %} checked{% endif %} data-toggle="toggle" aria-describedby="plugContentAflatounHelp" class="changes-size">
			  <small id="plugContentAflatounHelp" class="form-text text-muted">Education Platform for kids</small>
			</div>
		</div>

		<div class="form-row visual-group">
			<div class="form-group col-md-4">
			  <label for="plugContentEdupi">Khan Academy FR <span>(11.89GiB)</span></label>
			  <input type="checkbox" name="plugContentEdupi" id="config_kalite_fr" {% if "fr" in config.content.kalite %} checked{% endif %} data-toggle="toggle" aria-describedby="plugContentEdupiHelp" class="changes-size">
			  <small id="plugContentEdupiHelp" class="form-text text-muted">Learning Platform (French)</small>
			</div>
			<div class="form-group col-md-4">
			  <label for="plugContentEdupi">Khan Academy EN <span>(47.68GiB)</span></label>
			  <input type="checkbox" name="plugContentEdupi" id="config_kalite_en" {% if "en" in config.content.kalite %} checked{% endif %} data-toggle="toggle" aria-describedby="plugContentEdupiHelp" class="changes-size">
			  <small id="plugContentEdupiHelp" class="form-text text-muted">Learning Platform (English)</small>
			</div>
			<div class="form-group col-md-4">
			  <label for="plugContentEdupi">Khan Academy ES <span>(23.06GiB)</span></label>
			  <input type="checkbox" name="plugContentEdupi" id="config_kalite_es" {% if "es" in config.content.kalite %} checked{% endif %} data-toggle="toggle" aria-describedby="plugContentEdupiHelp" class="changes-size">
			  <small id="plugContentEdupiHelp" class="form-text text-muted">Learning Platform (Spanish)</small>
			</div>
		</div>

		<div class="form-row visual-group">
			<div class="form-group col-md-4">
			  <label for="plugContentEdupi">Wikifundi FR <span>(9.75GiB)</span></label>
			  <input type="checkbox" name="plugContentEdupi" id="config_wikifundi_fr" {% if "fr" in config.content.wikifundi %} checked{% endif %} data-toggle="toggle" aria-describedby="plugContentEdupiHelp" class="changes-size">
			  <small id="plugContentEdupiHelp" class="form-text text-muted">Wikipedia-like Editing Platform (French)</small>
			</div>
			<div class="form-group col-md-4">
			  <label for="plugContentEdupi">Wikifundi EN <span>(11.74GiB)</span></label>
			  <input type="checkbox" name="plugContentEdupi" id="config_wikifundi_en" {% if "en" in config.content.wikifundi %} checked{% endif %} data-toggle="toggle" aria-describedby="plugContentEdupiHelp" class="changes-size">
			  <small id="plugContentEdupiHelp" class="form-text text-muted">Wikipedia-like Editing Platform (English)</small>
			</div>
		</div>
  	</div>
	

  	<div class="tab-pane fade" id="contents" role="tabpanel" aria-labelledby="contents-tab">
  		<h3>Static Contents (ZIM & websites)</h3>
  		<h4>Selected Packages</h4>
  		<div class="form-row visual-group">
			<div class="col-md-12">
				<table id="selected_packages_list" class="table table-bordered table-striped">
			  	<thead><tr><th>Name</th><th>Size</th><th>Version</th></tr></thead>
			  	<tbody>
			  		{% for package in packages %}
			  		<tr id="selected-row-{{ package.skey }}"><td><a href="#" class="remove-package" data-package-id="{{ package.skey }}"><i data-container="body" data-toggle="popover" data-placement="top" data-trigger="hover" data-content="{{ package.langid }}" class="fas fa-minus-circle primary"></i></a> <strong>{{ package|parsed_sname }}</strong>{% if package.tags %} {% for tag in package.tags %}<span class="badge badge-pill badge-secondary package-tag">{{ tag }}</span>{% endfor %}{% endif %}<p><em>{{ package.description }}</em></p></td><td>{{ package.size|human_size }}</td><td>{{ package.version }}</td></tr>
			  		{% endfor %}
			  	</tbody>
			  </table>
			</div>
		</div>

  		<h4>Available Packages</h4>
		<div class="form-row visual-group">
			<div class="col-md-12">
			  <select name="lang_filter" id="lang_filter" class="form-control">
			  	<option>Select a language to filter</option>
			  	{% for lang_code, lang_name in packages_langs.items %}
			  	<option value="{{ lang_code }}">{{ lang_name }}</option>
			  	{% endfor %}
			  </select>
			  <p> </p>
			  <div class="table-cont">
			  <table id="packages_list" class="table table-bordered table-striped">
			  	<thead><tr><th>Name</th><th>Size</th><th>Version</th></tr></thead>
			  	<tbody>
			  	</tbody>
			  </table>
			</div>
			</div>
		</div>
  	</div>

	</div> <!-- tabs -->
	<button type="submit" class="btn btn-primary">Save</button>
	</form>
{% endblock %}

{% block javascript %}
	var packages = [{% for package in packages %}"{{ package.langid }}",{% endfor %}];

	function onRefresh() {
		$('[data-toggle="popover"]').popover();
		registerAddPackage();
		registerRemovePackage();
	}

	function registerAddPackage() {
		$('.add-package').on('click', function (e) {
			e.preventDefault();

			let safe_id = $(this).data('package-id');
			let parts = safe_id.split("_");
			let package_id = parts.slice(0, parts.length -1).join("_") + "." + parts[parts.length - 1];
			console.debug("adding " + package_id);
			console.debug("safe_id", safe_id);

			// add package to datalist and refresh size
			if (packages.indexOf(package_id) == -1) {
				console.debug("adding " + package_id);
				packages.push(package_id);
				refreshSize();
			}
			
			// add row to table
			let selected_table = $('#selected_packages_list tbody');
			let catalog_row = $('tr#catalog-row-' + safe_id);
			let selected_row = $('<tr id="selected-row-'+ safe_id +'">');
			selected_row.html(catalog_row.html());
			selected_table.append(selected_row);
			// update UI inside row
			$(selected_row.find('.fa-plus-circle')).attr('class', 'fas fa-minus-circle primary');
			$(selected_row.find('.add-package')).attr('class', 'remove-package');
			
			registerRemovePackage();
		});
	}

	function registerRemovePackage() {
		$('.remove-package').on('click', function (e) {
			e.preventDefault();
			e.preventDefault();

			let safe_id = $(this).data('package-id');
			let parts = safe_id.split("_");
			let package_id = parts.slice(0, parts.length -1).join("_") + "." + parts[parts.length - 1];
			console.debug("removing " + package_id);
			console.debug("safe_id", safe_id);

			// remove package from datalist and refresh size
			if (packages.indexOf(package_id) != -1) {
				console.debug("removing " + package_id);
				packages.splice(packages.indexOf(package_id), 1);
				refreshSize();
			}

			// remove row from table
			let selected_row = $('#selected-row-'+ safe_id);
			selected_row.remove();
		});
	}

	function registerZIMChooser() {
		$('#lang_filter').on('change', function(e) {
			let packages_list = $('#packages_list tbody');
			$.getJSON("/api/packages/lang_" + $(this).val(), function () {})
				.done(function (data) {
					console.log(data);
					packages_list.empty();
					$.each(data.packages, function(package_key, package) {

						// tags to badges
						let tags = $('<span>');
						$.each(package.tags, function (ti, tag) {
							tags.append($('<span class="badge badge-pill badge-secondary package-tag">' + tag + '</span>\n'));
						});

						let row = $('<tr id="catalog-row-'+ package.skey +'">');
						let main_td = '<a href="#" class="add-package" data-package-id="'+package.skey +'"><i data-container="body" data-toggle="popover" data-placement="top" data-trigger="hover" data-content="'+ package_key +'" class="fas fa-plus-circle primary"></i></a> <strong>' + package.sname + '</strong> ' + tags.html() + '<p><em>' + package.description+'</em></p>';
						row.append($('<td>').html(main_td));
						row.append($('<td>').text(package.hsize));
						row.append($('<td>').text(package.version));
					
						packages_list.append(row);
					});

					// register actions
					onRefresh();

				})
				.fail(function (error) {
					console.log(error);
					alert("FAILED: " + error.toString());
				});
		});
	}

	function onInit() {
		console.debug("initialization");
		refreshSize();

		// register tab behavior
		$('#configMenuTabHolder a').on('click', function (e) {
		  e.preventDefault()
		  $(this).tab('show');
		});

		// register contents checkboxes
		$('.changes-size').on('change', function (e) {
			refreshSize();
		});

		// register ZIM chooser
		registerZIMChooser();

		// register form submission
		$('form').on('submit', function (e) {
			e.preventDefault();
			console.log("submitting form");
		});

		// first refresh run
		onRefresh();
	}

	function refreshSize() {
		let config = {
			edupi: $('#config_edupi').is(':checked'),
			edupi_resources: $('#config_edupi_resources').val(),
			aflatoun: $('#config_aflatoun').is(':checked'),
			kalite: [],
			wikifundi: [],
			packages: packages,
		};
		$.each(["fr", "en", "es"], function (i, lang) {
			if ($('#config_kalite_' + lang).is(':checked')) {
				config.kalite.push(lang);
			}
			if ($('#config_wikifundi_' + lang).is(':checked')) {
				config.wikifundi.push(lang);
			}
		});
		console.log(config);
		$.post("/api/get_size", JSON.stringify(config), function () {})
			.done(function (data) {
				console.log(data);
				$('#image_req_size').text(data.hsize);
				
				if (data.media_size == null) {
					$('#sd_size_holder')[0].className = "danger";
					$('#sd_size').text("n/a");
				} else {
					$('#sd_size_holder')[0].className = "success";
					$('#sd_size').text(data.media_size);
				}
				
			})
			.fail(function (error) {
				console.log(error);
			});
	}

	onInit();
{% endblock %}
