{% extends "base.html" %}
{% load static %}
{% load manager %}

{% block content %}

	{% if form.errors or form.non_field_errors %}<div class="alert alert-danger">Your config has errors and can not be saved. Please fix them and retry.{% if form.non_field_errors %}<br />{{ form.non_field_errors }}{% endif %}</div>{% endif %}

	<ul class="nav nav-tabs" id="configMenuTabHolder" role="tablist">
		<li class="nav-item"><a class="nav-link active" id="general-tab" data-toggle="tab" href="#general" role="tab" aria-controls="general" aria-selected="true">General</a></li>
		<li class="nav-item"><a class="nav-link" id="branding-tab" data-toggle="tab" href="#branding" role="tab" aria-controls="branding" aria-selected="false">Branding</a></li>
		<li class="nav-item"><a class="nav-link" id="tools-tab" data-toggle="tab" href="#tools" role="tab" aria-controls="tools" aria-selected="false">Tools</a></li>
		<li class="nav-item"><a class="nav-link" id="contents-tab" data-toggle="tab" href="#contents" role="tab" aria-controls="contents" aria-selected="false">Contents</a></li>
		<li class="nav-item"><a class="nav-link disabled">
			<span id="img_size_holder" class="info" data-container="body" data-toggle="popover" data-trigger="hover" data-content="Size of Selected Contents"><i class="fas fa-hdd"></i> <span id="image_req_size">?</span></span> â€“ 
			<span id="sd_size_holder" class="warning" data-container="body" data-toggle="popover" data-trigger="hover" data-content="Minimum SD-card Size required for Selected Contents"><i class="fa fa-save"></i> <span id="sd_size">?</span></span>
		</a></li>
	</ul>

	<p></p>

	<form method="POST" enctype="multipart/form-data" class="edit-config">
	{% csrf_token %}
	<div class="tab-content" id="configMenuTabHolderContent">
	<div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
		<h3>Plug</h3>
		<div class="form-row visual-group">
			<div class="form-group col-md-6">
				{% include "_input_field.html" with field=form.project_name placeholder="My Hotspot" %}
			</div>
			<div class="form-group col-md-6">
				{% include "_input_field.html" with field=form.name placeholder="My Project Config" %}
			</div>
		</div>

		<h3>Region</h3>
		<div class="form-row visual-group">
			<div class="form-group col-md-6">
			  {% include "_label_for.html" with field=form.language %}
			  {{ form.language.value }}
			  {{ form.language|as_widget }}
			</div>
			<div class="form-group col-md-6">
			  {% include "_label_for.html" with field=form.timezone %}
			  {{ form.timezone|as_widget }}
			</div>
		</div>

		<h3>Security</h3>
		<div class="form-row visual-group">
			<div class="form-group col-md-4">
				{% include "_input_field.html" with field=form.wifi_password placeholder="Open WiFi" %}
			</div>
			<div class="form-group col-md-4">
				{% include "_input_field.html" with field=form.admin_account %}
			</div>
			<div class="form-group col-md-4">
				{% include "_input_field.html" with field=form.admin_password %}
			</div>
		</div>
	</div>

	<div class="tab-pane fade" id="branding" role="tabpanel" aria-labelledby="branding-tab">
		
		<h3>Branding</h3>
		<div class="form-row visual-group">
			<div class="form-group col-md-4">
				{% include "_input_field.html" with field=form.branding_logo type=file use_raw=1 %}
			  	{% include "_file_preview.html" with field=form.branding_logo %}
			</div>
			<div class="form-group col-md-4">
				{% include "_input_field.html" with field=form.branding_favicon type=file use_raw=1 %}
				{% include "_file_preview.html" with field=form.branding_favicon class="favicon" %}
			</div>
			<div class="form-group col-md-4">
			  {% include "_input_field.html" with field=form.branding_css type=file use_raw=1 %}
			</div>
		</div>

	</div>

  	<div class="tab-pane fade" id="tools" role="tabpanel" aria-labelledby="tools-tab">
  		<h3>Tools</h3>
		<div class="form-row visual-group">
			<div class="form-group col-md-4">
				{% include "_input_field.html" with field=form.content_edupi type="checkbox" size="10 MiB" %}
			</div>
			<div class="form-group col-md-4">
				{% include "_input_field.html" with field=form.content_edupi_resources changes_size=1 %}
			</div>
			<div class="form-group col-md-4">
				{% include "_input_field.html" with field=form.content_aflatoun type="checkbox" size="3.67GiB" %}
			</div>
		</div>

		<div class="form-row visual-group">
			<div class="form-group col-md-4">
				{% include "_input_field.html" with field=form.content_kalite_fr type="checkbox" size="11.35GiB" %}
			</div>
			<div class="form-group col-md-4">
				{% include "_input_field.html" with field=form.content_kalite_en type="checkbox" size="47.68GiB" %}
			</div>
			<div class="form-group col-md-4">
				{% include "_input_field.html" with field=form.content_kalite_es type="checkbox" size="22.11GiB" %}
			</div>
		</div>

		<div class="form-row visual-group">
			<div class="form-group col-md-4">
				{% include "_input_field.html" with field=form.content_wikifundi_fr type="checkbox" size="2.92GiB" %}
			</div>
			<div class="form-group col-md-4">
				{% include "_input_field.html" with field=form.content_wikifundi_en type="checkbox" size="3.2GiB" %}
			</div>
		</div>
  	</div>
	

  	<div class="tab-pane fade" id="contents" role="tabpanel" aria-labelledby="contents-tab">
  		<h3>Static Contents (ZIM & websites)</h3>
  		<h4>Selected Packages</h4>
  		{% if form.content_zims.errors %}<div class="alert alert-danger">Your selection has errors: {{ form.content_zims.errors }}</div>{% endif %}
  		<input type="hidden" id="{{ form.content_zims.id_for_label }}" class="form-control" 
  			   value="{{ form.content_zims.value|default_if_none:"" }}"
  			   name="{{ form.content_zims.html_name }}"/>
  		<div class="form-row visual-group">
			<div class="col-md-12">
				<table id="selected_packages_list" class="table table-bordered table-striped">
			  	<thead><tr><th>Name</th><th>Size</th><th>Version</th></tr></thead>
			  	<tbody>
			  		{% for package in form.content_zims.value|as_packages %}
			  		<tr id="selected-row-{{ package.skey }}"><td><a href="#" class="remove-package" data-package-id="{{ package.skey }}"><i data-container="body" data-toggle="popover" data-placement="top" data-trigger="hover" data-content="{{ package.langid }}" class="fas fa-minus-circle primary"></i></a> <strong>{{ package|parsed_sname }}</strong>{% if package.tags %} {% for tag in package.tags %}<span class="badge badge-pill badge-secondary package-tag">{{ tag }}</span>{% endfor %}{% endif %}<p><em>{{ package.description }}</em></p></td><td>{{ package.size|human_size }}</td><td>{{ package.version }}</td></tr>
			  		{% endfor %}
			  	</tbody>
			  </table>
			</div>
		</div>

  		<h4>Available Packages</h4>
		<div class="form-row visual-group">
			<div class="col-md-12">
			  <select name="lang_filter" id="lang_filter" class="form-control">
			  	<option>Select a language to filter</option>
			  	{% for lang_code, lang_name in packages_langs.items %}
			  	<option value="{{ lang_code }}">{{ lang_name }}</option>
			  	{% endfor %}
			  </select>
			  <p> </p>
			  <div class="table-cont">
			  <table id="packages_list" class="table table-bordered table-striped">
			  	<thead><tr><th>Name</th><th>Size</th><th>Version</th></tr></thead>
			  	<tbody>
			  	</tbody>
			  </table>
			</div>
			</div>
		</div>
  	</div>

	</div> <!-- tabs -->
	<button type="submit" class="btn btn-primary">Save</button>
	</form>
{% endblock %}

{% block javascript %}
	var edupi_id = "{{ form.content_edupi.id_for_label }}";
	var edupi_resources_id = "{{ form.content_edupi_resources.id_for_label }}";
	var aflatoun_id = "{{ form.content_aflatoun.id_for_label }}";
	var kalite_fr_id = "{{ form.content_kalite_fr.id_for_label }}";
	var kalite_en_id = "{{ form.content_kalite_en.id_for_label }}";
	var kalite_es_id = "{{ form.content_kalite_es.id_for_label }}";
	var wikifundi_fr_id = "{{ form.content_wikifundi_fr.id_for_label }}";
	var wikifundi_en_id = "{{ form.content_wikifundi_en.id_for_label }}";
	var zim_field_id = "{{ form.content_zims.id_for_label }}";
	var zim_field = $("#" + zim_field_id);
	var packages = [{% for package in form.content_zims.value|as_packages %}"{{ package.langid }}",{% endfor %}];

	function syncPackagesField() {
		zim_field.val(JSON.stringify(packages));
	}

	function onRefresh() {
		$('[data-toggle="popover"]').popover();
		registerAddPackage();
		registerRemovePackage();
	}

	function registerAddPackage() {
		$('.add-package').on('click', function (e) {
			e.preventDefault();

			let safe_id = $(this).data('package-id');
			let parts = safe_id.split("_");
			let package_id = parts.slice(0, parts.length -1).join("_") + "." + parts[parts.length - 1];
			<!-- console.debug("adding " + package_id); -->
			console.debug("safe_id", safe_id);

			// add package to datalist and refresh size
			if (packages.indexOf(package_id) == -1) {
				console.debug("adding " + package_id);
				packages.push(package_id);
				refreshSize();

				// add row to table
				let selected_table = $('#selected_packages_list tbody');
				let catalog_row = $('tr#catalog-row-' + safe_id);
				let selected_row = $('<tr id="selected-row-'+ safe_id +'">');
				selected_row.html(catalog_row.html());
				selected_table.append(selected_row);
				// update UI inside row
				$(selected_row.find('.fa-plus-circle')).attr('class', 'fas fa-minus-circle primary');
				$(selected_row.find('.add-package')).attr('class', 'remove-package');
			}

			// refresh form field
			syncPackagesField();
			
			registerRemovePackage();
		});
	}

	function registerRemovePackage() {
		$('.remove-package').on('click', function (e) {
			e.preventDefault();
			e.preventDefault();

			let safe_id = $(this).data('package-id');
			let parts = safe_id.split("_");
			let package_id = parts.slice(0, parts.length -1).join("_") + "." + parts[parts.length - 1];
			console.debug("removing " + package_id);
			console.debug("safe_id", safe_id);

			// remove package from datalist and refresh size
			if (packages.indexOf(package_id) != -1) {
				console.debug("removing " + package_id);
				packages.splice(packages.indexOf(package_id), 1);
				refreshSize();
			}

			// remove row from table
			let selected_row = $('#selected-row-'+ safe_id);
			selected_row.remove();

			// refresh form field
			syncPackagesField();
		});
	}

	function registerZIMChooser() {
		$('#lang_filter').on('change', function(e) {
			let packages_list = $('#packages_list tbody');
			$.getJSON("/api/packages/lang_" + $(this).val(), function () {})
				.done(function (data) {
					console.log(data);
					packages_list.empty();
					$.each(data.packages, function(package_key, package) {

						// tags to badges
						let tags = $('<span>');
						$.each(package.tags, function (ti, tag) {
							tags.append($('<span class="badge badge-pill badge-secondary package-tag">' + tag + '</span>\n'));
						});

						let row = $('<tr id="catalog-row-'+ package.skey +'">');
						let main_td = '<a href="#" class="add-package" data-package-id="'+package.skey +'"><i data-container="body" data-toggle="popover" data-placement="top" data-trigger="hover" data-content="'+ package_key +'" class="fas fa-plus-circle primary"></i></a> <strong>' + package.sname + '</strong> ' + tags.html() + '<p><em>' + package.description+'</em></p>';
						row.append($('<td>').html(main_td));
						row.append($('<td>').text(package.hsize));
						row.append($('<td>').text(package.version));
					
						packages_list.append(row);
					});

					// register actions
					onRefresh();

				})
				.fail(function (error) {
					console.log(error);
					alert("FAILED: " + error.toString());
				});
		});
	}

	function onInit() {
		console.debug("initialization");
		refreshSize();

		// register tab behavior
		$('#configMenuTabHolder a').on('click', function (e) {
		  e.preventDefault()
		  $(this).tab('show');
		});

		// register contents checkboxes
		$('.changes-size').on('change', function (e) {
			refreshSize();
		});

		// register ZIM chooser
		registerZIMChooser();

		// first refresh run
		onRefresh();
	}

	function refreshSize() {
		let config = {
			edupi: $('#' + edupi_id).is(':checked'),
			edupi_resources: $('#' + edupi_resources_id).val(),
			aflatoun: $('#' + aflatoun_id).is(':checked'),
			kalite: [],
			wikifundi: [],
			packages: packages,
		};
		$.each(["fr", "en", "es"], function (i, lang) {
			if ($('#' + eval('kalite_' + lang + '_id')).is(':checked')) {
				config.kalite.push(lang);
			}
			if (lang != "es") {
				if ($('#' + eval('wikifundi_' + lang + '_id')).is(':checked')) {
					config.wikifundi.push(lang);
				}
			}
		});
		console.log(config);
		$.post("/api/get_size", JSON.stringify(config), function () {})
			.done(function (data) {
				console.log(data);
				$('#image_req_size').text(data.hsize);
				
				if (data.media_size == null) {
					$('#sd_size_holder')[0].className = "danger";
					$('#sd_size').text("n/a");
				} else {
					$('#sd_size_holder')[0].className = "success";
					$('#sd_size').text(data.media_size);
				}
				
			})
			.fail(function (error) {
				console.log(error);
			});
	}

	onInit();
{% endblock %}
